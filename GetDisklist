#!/usr/local/bin/zsh
cd /TopStor/
iscsitargets='/pacedata/iscsitargets'
runningpools='/pacedata/pools/runningpools'
iscsimapping='/pacedata/iscsimapping'
traf='/var/www/html/des20/Data/disklist.txt';
trafupdate='/var/www/html/des20/Data/disklist.txtupdated';
gpool=("")
traffic="";
s=1
hostns=(`cat $iscsimapping | grep -v notconn | awk '{print $1}'`)
disks=(`cat $iscsimapping | grep -v notconn | awk '{print $3}'`)
diskcount=1;
result='[';
for disk in "${disks[@]}"; do
 cat $runningpools | grep $disk 
 if [ $? -ne 0 ]; then
  diskhost='free';
  diskpool='free'; 
 else
  diskhost=`cat $runningpools | grep $disk | awk '{print $NF}'`;
  diskpool=`cat $runningpools | grep $disk | awk '{print $2}'`;
  poolrole=`cat $runningpools | grep $disk | awk '{print $5}'`;
  grouptype='raid_single_parity';
  poolrole='spare';
 fi 
 disksize=`cat $iscsimapping | grep -w $disk | awk '{print $4}'`
 subres=`./jsonthis3.sh id $diskcount name $disk host $diskhost pool $diskpool size $disksize poolrole $poolrole grouptype $grouptype`
 result=$result$subres,
 diskcount=$((diskcount+1));
done
result=` echo $result | rev | cut -c 2- | rev`']';
echo $result > $traf
resdate=`/bin/date +%s`;
res=` ./jsonthis3.sh update $resdate`
echo $res > $trafupdate;
