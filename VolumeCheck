#!/bin/sh
export ETCDCTL_API=3
cd /TopStor/
web='/var/www/html/des20/Data/CIFSstatus.log';
logging='/var/www/html/des20/Data/currentinfo2.log'
glog='/var/www/html/des20/Data/TopStor.log';
runningpools='/pacedata/pools/runningpools'
txtres='/TopStordata/'`basename $0`'.txt'
rm -rf $txtres 2>/dev/null
echo $@ > /root/VolumeCheck
pool=`echo $@ | awk -F'pool=' '{print $2}' | awk '{print $1}'`;
userreq=`echo $@ | awk -F'user=' '{print $2}' | awk '{print $1}'`;
myhost=`hostname -s`
ips='0'
pools=`mount | grep pdhcp | awk '{print $1}'`
echo $pools | grep pdhcp
if [ $? -ne 0 ];
then
 exit
fi
echo "${pools[@]}" | while read pool;
do
 ips=`cat /$pool/smb.* | grep SUMMARY | awk '{print $NF}' | awk -F'/' '{print $8}'`
 echo "${ips[@]}" | while read ip;
 do
  docker ps | grep $ip  >/dev/null
  if [ $? -ne 0 ];
  then
   ./etcddel.py vol $ip
   pcs resource delete cifs-$pool-$ip 2>/dev/null
   pcs resource delete home-$pool-$ip 2>/dev/null
   /TopStor/VolumeActivateCIFSImport pool=$pool user=system
   /TopStor/VolumeActivateHomeImport pool=$pool user=system
  fi
 done
 ips=`cat /$pool/exports.* | grep SUMMARY | awk '{print $NF}' | awk -F'/' '{print $10}'`
 echo "${ips[@]}" | while read ip;
 do
  cat /etc/exports | grep $ip >/dev/null 
  if [ $? -ne 0 ];
  then
   ./etcddel.py vol $ip
   pcs resource delete nfs-$pool-$ip
   /TopStor/VolumeActivateNFSImport pool=$pool user=system
  fi
 done
done
